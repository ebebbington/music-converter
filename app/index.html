<!DOCTYPE html>
<html>
    <head>
        <title>Music Converter</title>
    </head>
    <body>
        <p>Yes, this app is supposed to look horrible.</p>
        <form>
            <div class="flex">
              <label for="url">URL: </label>  
              <input id="url" name="url" type="text" data-urls="" />
              <button id="add" type="button">Add</button>
            </div>
            <div class="flex">
            <label for="increaseBy">Increase by: </label>
            <input type="text" name="increaseBy" value="1.5dB" style="display: block;" />
            </div>
            <button id="convert" type="button">Convert</button>
        </form>
    </body>
    <style>
        .flex {
            display: flex;
        }
    </style>
    <script>
        document.querySelector('#add').addEventListener('click', () => {
            const $url = document.querySelector('#url')
            const url = $url.value
            $url.value = null
            const urls = $url.getAttribute('data-urls')
            const delimeter = urls ? "," : ""
            $url.setAttribute('data-urls', urls + delimeter + url)
        })
        document.querySelector('#convert').addEventListener('click', async (e) => {
            const p = document.createElement('p')
            p.textContent = "Uploading..."
            document.body.appendChild(p)
            const $url = document.querySelector('#url')
            const urls = $url.getAttribute('data-urls').split(',')
            for (const url of urls) {
                $url.value = url
                const res = await fetch("/", {
                    method: "POST",
                    body: new FormData(document.querySelector('form'))
                })
                const blob = await res.blob()
                const a = document.createElement('a')
                a.href = URL.createObjectURL(blob)
                const headers = res.headers
                const filename = headers.get('Content-Disposition').match(/filename=(.*\.mp3)/)[1]
                a.download = filename
                a.click()
            }
            p.remove()
            $url.value = null
            $url.setAttribute('data-urls', '')
            alert('done')
        })
    </script>
</html>